# ADR-0005: Add `IN` Membership Operator to Filtering Model and EF Core Translation

## Status

Accepted

## Date

2025-11-18

## Context

The filtering subsystem uses a portable, provider-agnostic AST (`FilterNode` and related records/enums) to represent predicate logic that can be serialized and applied across different execution strategies (POCO in-memory and EF Core query translation).

Common query patterns include membership tests (SQL `IN`) expressed in code as constant-collection `.Contains(member)` or array-literal `.Contains(member)`. Previously these were translated into OR-chains or not recognized uniformly across strategies which reduced portability and caused inefficient SQL generation.

Goals:
- Provide an explicit membership (`IN`) operator in the filter model so serialized filters are unambiguous.
- Ensure EF Core translation emits expressions that providers translate into efficient SQL `IN (...)` clauses.
- Keep POCO execution semantics equivalent (evaluate membership in-memory).

## Decision

1. Extend the filter model with a membership operator:
   - Add `FilterOperation.In` to `VisionaryCoder.Framework.Filtering.Abstractions.FilterOperation`.

2. Expression translation:
   - Detect patterns of constant-collection `Contains` (both static and instance forms) and translate them to `FilterCondition` with `Operator = FilterOperation.In` and `Value` set to a compact JSON array of element string representations.

3. EF Core execution optimization:
   - When translating `FilterCondition` with `Operator.In` for EF Core, deserialize the JSON array, convert items to the CLR element type, construct a typed array constant (e.g., `new int[] { 1, 2 }`) and generate `Enumerable.Contains(array, member)` in the expression tree. This expression is recognized and translated by EF Core providers into SQL `IN` clauses.

4. POCO execution:
   - For in-memory/POCO execution, deserialize the JSON array and evaluate membership via an OR-chain of equality comparisons (semantically equivalent) or using `Enumerable.Contains` on the deserialized collection when appropriate.

5. Samples and documentation:
   - Update samples to show variable-backed and literal collection `Contains` usage and confirm behavior for both POCO and EF Core.
   - Add ADR and README updates documenting the change and migration guidance.

## Consequences

- Positive:
  - Filters that express membership become first-class, serializable, and portable across execution strategies.
  - EF Core queries are optimized to produce `IN` clauses where supported, improving SQL readability and performance for moderate-sized lists.
  - Serialized filters are explicit and compact (JSON array payload) and can be stored or transmitted.

- Negative / Tradeoffs:
  - Using JSON payload inside `FilterCondition.Value` is a pragmatic serialization approach; it couples the value string format to a JSON array representation.
  - Very large IN lists may not be optimal as array constants; future work should consider parameterization, TVPs, or provider-specific optimizations for large membership sets.

## Alternatives Considered

- Represent membership with a dedicated `FilterCollectionCondition` subtype for membership instead of serializing to JSON in `FilterCondition.Value`.
  - Rejected for now because it would require larger API surface changes and more migration surface for existing serialization.

- Always translate to OR-chains for EF Core and POCO.
  - Rejected because EF Core can translate `Enumerable.Contains(array, member)` into `IN`, which produces better SQL and parameters handling in many providers.

- Provider-specific extension methods or annotations to signal `IN`.
  - Deferred: prefer a simple model-first approach that keeps the Abstractions small and portable.

## Implementation Notes

- The translator detects both `Enumerable.Contains(collection, value)` and `collection.Contains(value)` where `collection` is a constant-like expression (array, list literal, or captured variable). When found, the translator evaluates the collection at translation time and emits `FilterOperation.In` with JSON-serialized values.
- EF Core builder constructs a typed constant array and emits `Enumerable.Contains(array, member)`. POCO builder deserializes and evaluates in-memory.
- Unit tests should be added to cover translation and execution paths for both POCO and EF Core strategies. Consider tests verifying SQL generation when running against an EF Core provider.

## References

- ADR-0001: Architecture playbook and documentation conventions
- docs/filtering/collection-operations.md
- EF Core docs on how `Enumerable.Contains` is translated to `IN` by query providers

```text
Status: Accepted
Date: 2025-11-18
```
