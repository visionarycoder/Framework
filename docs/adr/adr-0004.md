# ADR-0004: Modular Copilot Instruction Architecture

## Status

Accepted

## Date

2025-11-14

## Context

The repository originally centralized extensive AI assistant (Copilot) guidance in a single monolithic file (`.github/copilot-instructions.md`). As the framework evolved, domain-specific generation needs (C# heuristics, design patterns, repo standards, best-practice capsules) increased. Maintaining one large file reduced clarity, made incremental evolution harder, and complicated discoverability for contributors seeking focused rules. We needed a structured, layered approach enabling:

- Separation of enterprise baseline vs. repository-scoped guidance.
- Faster iteration on domain-specific heuristics without risking unrelated sections.
- Clear precedence resolution for overlapping rules (global vs. local vs. domain).
- Easier onboarding through a navigable index.

## Decision

Adopt a modular instruction architecture under `.copilot/` with distinct, purpose-scoped markdown files:

- `copilot-instructions.md`: Base aggregation hub (domain index, workflow, quality checklist, precedence model).
- `csharp.instructions.md`: Core C# generation heuristics (async, DI, validation, observability, testing, performance, resilience patterns).
- `design-patterns.instructions.md`: Modern pattern example formatting (Intent/Structure/Code/Usage/Notes) and category guidance.
- `repo-standards.md`: Links code/documentation generation to structural and hygiene rules.

Integration with existing enterprise baseline retained via reference to `.github/copilot-instructions.md`. Domain capsules in `docs/best-practices/*/readme.md` remain authoritative for deep topic guidance and are indexed from `copilot-instructions.md`.

Scope In: Instruction authoring conventions, file locations, precedence layering, link strategy.
Scope Out: Tooling automation (future ADR), versioning semantics beyond existing changelog conventions.

## Consequences

### Positive

- Improved discoverability (single domain index table).
- Reduced merge friction by isolating edits to targeted files.
- Clear escalation path: base → domain → enterprise, minimizing ambiguity.
- Encourages incremental evolution and ADR linkage for future paradigm shifts.
- Facilitates automated validation (future scripting) of domain index vs. capsules.

### Negative

- More files to manage; requires contributor awareness of precedence rules.
- Initial cognitive overhead in learning modular layout.
- Risk of divergence if domain files are updated without syncing base index.

## Alternatives Considered

- Single Expanded File: Rejected due to maintainability and navigation complexity.
- Per-Domain Direct Embedding in Best-Practices README Only: Rejected—lacked centralized AI generation workflow and checklist.
- Tool-Generated Aggregation on Build: Deferred—adds build complexity; adopted simpler manual baseline first.

## Related Decisions

- ADR-0001 (referenced patterns for structural conventions) – informs layering and volatility-based decomposition principles leveraged in instruction heuristics.
- ADR-0002 / ADR-0003 (if security/integration topics) – domain capsules linked from base index.

## References

- `.github/copilot-instructions.md` (enterprise baseline)
- `.copilot/copilot-instructions.md` (aggregation hub)
- `.copilot/csharp.instructions.md`
- `.copilot/design-patterns.instructions.md`
- `.copilot/repo-standards.md`
- `docs/best-practices/*/readme.md`

## Follow-Up Actions

- Add CI script to verify domain index consistency (future ADR).
- Establish semantic versioning for modular instruction changes in base file.
- Optionally tag ADR updates in commit messages (`docs: adr-0004 modular instructions`).
