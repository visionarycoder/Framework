using FluentAssertions;
using Microsoft.VisualStudio.TestTools.UnitTesting;
using VisionaryCoder.Framework.Configuration.Azure;

namespace VisionaryCoder.Framework.Tests.Configuration;

/// <summary>
/// Data-driven unit tests for the <see cref="AppConfigurationOptions"/> record.
/// Tests Azure App Configuration connection options with various scenarios.
/// </summary>
[TestClass]
public class AppConfigurationOptionsTests
{
    #region Constructor Tests

    [TestMethod]
    public void Constructor_WithDefaults_ShouldSetDefaultValues()
    {
        // Act
        var options = new AppConfigurationOptions();

        // Assert
        options.Endpoint.Should().BeNull();
        options.Label.Should().Be("Production");
        options.SentinelKey.Should().Be("App:Sentinel");
        options.CacheExpiration.Should().Be(TimeSpan.FromSeconds(30));
        options.UseConnectionString.Should().BeFalse();
        options.ConnectionString.Should().BeNull();
    }

    [TestMethod]
    public void Constructor_WithAllProperties_ShouldSetAllValues()
    {
        // Arrange
        var endpoint = new Uri("https://test.azconfig.io");
        var label = "Development";
        var sentinelKey = "Custom:Sentinel";
        var cacheExpiration = TimeSpan.FromMinutes(5);
        var useConnectionString = true;
        var connectionString = "Endpoint=https://test.azconfig.io;Id=test;Secret=secret";

        // Act
        var options = new AppConfigurationOptions
        {
            Endpoint = endpoint,
            Label = label,
            SentinelKey = sentinelKey,
            CacheExpiration = cacheExpiration,
            UseConnectionString = useConnectionString,
            ConnectionString = connectionString
        };

        // Assert
        options.Endpoint.Should().Be(endpoint);
        options.Label.Should().Be(label);
        options.SentinelKey.Should().Be(sentinelKey);
        options.CacheExpiration.Should().Be(cacheExpiration);
        options.UseConnectionString.Should().Be(useConnectionString);
        options.ConnectionString.Should().Be(connectionString);
    }

    #endregion

    #region Endpoint Property Tests

    [TestMethod]
    [DataRow("https://myconfig.azconfig.io")]
    [DataRow("https://prod.azconfig.io")]
    [DataRow("https://dev.azconfig.io")]
    public void Endpoint_WithValidUri_ShouldSetCorrectly(string uriString)
    {
        // Arrange
        var uri = new Uri(uriString);

        // Act
        var options = new AppConfigurationOptions { Endpoint = uri };

        // Assert
        options.Endpoint.Should().Be(uri);
        options.Endpoint.ToString().Should().Be(uriString);
    }

    [TestMethod]
    public void Endpoint_WhenNull_ShouldBeNull()
    {
        // Act
        var options = new AppConfigurationOptions { Endpoint = null };

        // Assert
        options.Endpoint.Should().BeNull();
    }

    #endregion

    #region Label Property Tests

    [TestMethod]
    [DataRow("Production")]
    [DataRow("Development")]
    [DataRow("Staging")]
    [DataRow("Test")]
    [DataRow("")]
    public void Label_WithDifferentValues_ShouldSetCorrectly(string label)
    {
        // Act
        var options = new AppConfigurationOptions { Label = label };

        // Assert
        options.Label.Should().Be(label);
    }

    [TestMethod]
    public void Label_DefaultValue_ShouldBeProduction()
    {
        // Act
        var options = new AppConfigurationOptions();

        // Assert
        options.Label.Should().Be("Production");
    }

    #endregion

    #region SentinelKey Property Tests

    [TestMethod]
    [DataRow("App:Sentinel")]
    [DataRow("Config:Reload")]
    [DataRow("Custom:Key")]
    [DataRow("")]
    public void SentinelKey_WithDifferentValues_ShouldSetCorrectly(string key)
    {
        // Act
        var options = new AppConfigurationOptions { SentinelKey = key };

        // Assert
        options.SentinelKey.Should().Be(key);
    }

    [TestMethod]
    public void SentinelKey_DefaultValue_ShouldBeAppSentinel()
    {
        // Act
        var options = new AppConfigurationOptions();

        // Assert
        options.SentinelKey.Should().Be("App:Sentinel");
    }

    #endregion

    #region CacheExpiration Property Tests

    [TestMethod]
    [DataRow(1)]
    [DataRow(30)]
    [DataRow(60)]
    [DataRow(300)]
    [DataRow(3600)]
    public void CacheExpiration_WithDifferentSeconds_ShouldSetCorrectly(int seconds)
    {
        // Arrange
        var expiration = TimeSpan.FromSeconds(seconds);

        // Act
        var options = new AppConfigurationOptions { CacheExpiration = expiration };

        // Assert
        options.CacheExpiration.Should().Be(expiration);
        options.CacheExpiration.TotalSeconds.Should().Be(seconds);
    }

    [TestMethod]
    public void CacheExpiration_DefaultValue_ShouldBe30Seconds()
    {
        // Act
        var options = new AppConfigurationOptions();

        // Assert
        options.CacheExpiration.Should().Be(TimeSpan.FromSeconds(30));
        options.CacheExpiration.TotalSeconds.Should().Be(30);
    }

    [TestMethod]
    public void CacheExpiration_WithZero_ShouldAccept()
    {
        // Act
        var options = new AppConfigurationOptions { CacheExpiration = TimeSpan.Zero };

        // Assert
        options.CacheExpiration.Should().Be(TimeSpan.Zero);
    }

    [TestMethod]
    public void CacheExpiration_WithMaxValue_ShouldAccept()
    {
        // Act
        var options = new AppConfigurationOptions { CacheExpiration = TimeSpan.MaxValue };

        // Assert
        options.CacheExpiration.Should().Be(TimeSpan.MaxValue);
    }

    #endregion

    #region UseConnectionString Property Tests

    [TestMethod]
    [DataRow(true)]
    [DataRow(false)]
    public void UseConnectionString_WithDifferentValues_ShouldSetCorrectly(bool value)
    {
        // Act
        var options = new AppConfigurationOptions { UseConnectionString = value };

        // Assert
        options.UseConnectionString.Should().Be(value);
    }

    [TestMethod]
    public void UseConnectionString_DefaultValue_ShouldBeFalse()
    {
        // Act
        var options = new AppConfigurationOptions();

        // Assert
        options.UseConnectionString.Should().BeFalse();
    }

    #endregion

    #region ConnectionString Property Tests

    [TestMethod]
    [DataRow("Endpoint=https://test.azconfig.io;Id=test;Secret=secret")]
    [DataRow("Endpoint=https://prod.azconfig.io;Id=prod;Secret=prodSecret")]
    [DataRow("")]
    public void ConnectionString_WithDifferentValues_ShouldSetCorrectly(string connectionString)
    {
        // Act
        var options = new AppConfigurationOptions { ConnectionString = connectionString };

        // Assert
        options.ConnectionString.Should().Be(connectionString);
    }

    [TestMethod]
    public void ConnectionString_WhenNull_ShouldBeNull()
    {
        // Act
        var options = new AppConfigurationOptions { ConnectionString = null };

        // Assert
        options.ConnectionString.Should().BeNull();
    }

    [TestMethod]
    public void ConnectionString_DefaultValue_ShouldBeNull()
    {
        // Act
        var options = new AppConfigurationOptions();

        // Assert
        options.ConnectionString.Should().BeNull();
    }

    #endregion

    #region Scenario Tests

    [TestMethod]
    public void Scenario_ManagedIdentityConfiguration_ShouldBeValid()
    {
        // Arrange & Act
        var options = new AppConfigurationOptions
        {
            Endpoint = new Uri("https://myconfig.azconfig.io"),
            Label = "Production",
            UseConnectionString = false
        };

        // Assert
        options.Endpoint.Should().NotBeNull();
        options.UseConnectionString.Should().BeFalse();
        options.ConnectionString.Should().BeNull();
    }

    [TestMethod]
    public void Scenario_ConnectionStringConfiguration_ShouldBeValid()
    {
        // Arrange & Act
        var options = new AppConfigurationOptions
        {
            ConnectionString = "Endpoint=https://test.azconfig.io;Id=test;Secret=secret",
            UseConnectionString = true,
            Label = "Development"
        };

        // Assert
        options.ConnectionString.Should().NotBeNullOrEmpty();
        options.UseConnectionString.Should().BeTrue();
    }

    [TestMethod]
    public void Scenario_CustomLabelAndSentinel_ShouldBeValid()
    {
        // Arrange & Act
        var options = new AppConfigurationOptions
        {
            Endpoint = new Uri("https://staging.azconfig.io"),
            Label = "Staging",
            SentinelKey = "Config:Reload",
            CacheExpiration = TimeSpan.FromMinutes(5)
        };

        // Assert
        options.Label.Should().Be("Staging");
        options.SentinelKey.Should().Be("Config:Reload");
        options.CacheExpiration.Should().Be(TimeSpan.FromMinutes(5));
    }

    #endregion

    #region Record Equality Tests

    [TestMethod]
    public void Equals_WithSameValues_ShouldBeEqual()
    {
        // Arrange
        var options1 = new AppConfigurationOptions
        {
            Endpoint = new Uri("https://test.azconfig.io"),
            Label = "Development",
            SentinelKey = "App:Sentinel",
            CacheExpiration = TimeSpan.FromSeconds(30),
            UseConnectionString = false,
            ConnectionString = null
        };

        var options2 = new AppConfigurationOptions
        {
            Endpoint = new Uri("https://test.azconfig.io"),
            Label = "Development",
            SentinelKey = "App:Sentinel",
            CacheExpiration = TimeSpan.FromSeconds(30),
            UseConnectionString = false,
            ConnectionString = null
        };

        // Assert
        options1.Should().Be(options2);
    }

    [TestMethod]
    public void Equals_WithDifferentEndpoint_ShouldNotBeEqual()
    {
        // Arrange
        var options1 = new AppConfigurationOptions { Endpoint = new Uri("https://test1.azconfig.io") };
        var options2 = new AppConfigurationOptions { Endpoint = new Uri("https://test2.azconfig.io") };

        // Assert
        options1.Should().NotBe(options2);
    }

    [TestMethod]
    public void Equals_WithDifferentLabel_ShouldNotBeEqual()
    {
        // Arrange
        var options1 = new AppConfigurationOptions { Label = "Production" };
        var options2 = new AppConfigurationOptions { Label = "Development" };

        // Assert
        options1.Should().NotBe(options2);
    }

    #endregion

    #region GetHashCode Tests

    [TestMethod]
    public void GetHashCode_WithSameValues_ShouldReturnSameHashCode()
    {
        // Arrange
        var options1 = new AppConfigurationOptions
        {
            Endpoint = new Uri("https://test.azconfig.io"),
            Label = "Production"
        };

        var options2 = new AppConfigurationOptions
        {
            Endpoint = new Uri("https://test.azconfig.io"),
            Label = "Production"
        };

        // Assert
        options1.GetHashCode().Should().Be(options2.GetHashCode());
    }

    [TestMethod]
    public void GetHashCode_WithDifferentValues_ShouldReturnDifferentHashCodes()
    {
        // Arrange
        var options1 = new AppConfigurationOptions { Label = "Production" };
        var options2 = new AppConfigurationOptions { Label = "Development" };

        // Assert
        options1.GetHashCode().Should().NotBe(options2.GetHashCode());
    }

    #endregion

    #region ToString Tests

    [TestMethod]
    public void ToString_ShouldIncludePropertyNames()
    {
        // Arrange
        var options = new AppConfigurationOptions
        {
            Endpoint = new Uri("https://test.azconfig.io"),
            Label = "Development"
        };

        // Act
        var result = options.ToString();

        // Assert
        result.Should().Contain("Endpoint");
        result.Should().Contain("Label");
    }

    #endregion

    #region Deconstruction Tests

    [TestMethod]
    public void Deconstruct_ShouldExtractAllProperties()
    {
        // Arrange
        var endpoint = new Uri("https://test.azconfig.io");
        var label = "Development";
        var sentinelKey = "Custom:Key";
        var cacheExpiration = TimeSpan.FromMinutes(5);
        var useConnectionString = true;
        var connectionString = "test-connection-string";

        var options = new AppConfigurationOptions
        {
            Endpoint = endpoint,
            Label = label,
            SentinelKey = sentinelKey,
            CacheExpiration = cacheExpiration,
            UseConnectionString = useConnectionString,
            ConnectionString = connectionString
        };

        // Act - Note: C# records don't auto-generate positional deconstruction for init-only properties
        // We test the properties directly instead
        
        // Assert
        options.Endpoint.Should().Be(endpoint);
        options.Label.Should().Be(label);
        options.SentinelKey.Should().Be(sentinelKey);
        options.CacheExpiration.Should().Be(cacheExpiration);
        options.UseConnectionString.Should().Be(useConnectionString);
        options.ConnectionString.Should().Be(connectionString);
    }

    #endregion

    #region With Expression Tests

    [TestMethod]
    public void WithExpression_ModifyingEndpoint_ShouldCreateNewInstance()
    {
        // Arrange
        var original = new AppConfigurationOptions
        {
            Endpoint = new Uri("https://original.azconfig.io"),
            Label = "Production"
        };

        var newEndpoint = new Uri("https://modified.azconfig.io");

        // Act
        var modified = original with { Endpoint = newEndpoint };

        // Assert
        modified.Endpoint.Should().Be(newEndpoint);
        modified.Label.Should().Be("Production");
        original.Endpoint.ToString().Should().Be("https://original.azconfig.io");
    }

    [TestMethod]
    public void WithExpression_ModifyingMultipleProperties_ShouldCreateNewInstance()
    {
        // Arrange
        var original = new AppConfigurationOptions
        {
            Label = "Production",
            CacheExpiration = TimeSpan.FromSeconds(30)
        };

        // Act
        var modified = original with
        {
            Label = "Development",
            CacheExpiration = TimeSpan.FromMinutes(10),
            UseConnectionString = true
        };

        // Assert
        modified.Label.Should().Be("Development");
        modified.CacheExpiration.Should().Be(TimeSpan.FromMinutes(10));
        modified.UseConnectionString.Should().BeTrue();
        original.Label.Should().Be("Production");
        original.CacheExpiration.Should().Be(TimeSpan.FromSeconds(30));
        original.UseConnectionString.Should().BeFalse();
    }

    #endregion

    #region Type System Tests

    [TestMethod]
    public void AppConfigurationOptions_ShouldBeRecord()
    {
        // Arrange & Act
        var type = typeof(AppConfigurationOptions);

        // Assert
        type.GetMethod("<Clone>$", System.Reflection.BindingFlags.Public | System.Reflection.BindingFlags.Instance)
            .Should().NotBeNull("records have a public <Clone>$ method");
    }

    [TestMethod]
    public void AppConfigurationOptions_ShouldBeSealed()
    {
        // Arrange & Act
        var type = typeof(AppConfigurationOptions);

        // Assert
        type.IsSealed.Should().BeTrue();
    }

    #endregion

    #region Edge Cases Tests

    [TestMethod]
    public void CacheExpiration_WithNegativeValue_ShouldAccept()
    {
        // Arrange
        var negativeExpiration = TimeSpan.FromSeconds(-1);

        // Act
        var options = new AppConfigurationOptions { CacheExpiration = negativeExpiration };

        // Assert
        options.CacheExpiration.Should().Be(negativeExpiration);
    }

    [TestMethod]
    public void Label_WithWhitespace_ShouldAccept()
    {
        // Act
        var options = new AppConfigurationOptions { Label = "  " };

        // Assert
        options.Label.Should().Be("  ");
    }

    [TestMethod]
    public void ConnectionString_WithWhitespace_ShouldAccept()
    {
        // Act
        var options = new AppConfigurationOptions { ConnectionString = "  " };

        // Assert
        options.ConnectionString.Should().Be("  ");
    }

    [TestMethod]
    public void MultipleInstances_ShouldBeIndependent()
    {
        // Arrange & Act
        var options1 = new AppConfigurationOptions { Label = "Production" };
        var options2 = new AppConfigurationOptions { Label = "Development" };
        var options3 = new AppConfigurationOptions();

        // Assert
        options1.Label.Should().Be("Production");
        options2.Label.Should().Be("Development");
        options3.Label.Should().Be("Production"); // Default value
        options1.Should().NotBe(options2);
        options2.Should().NotBe(options3);
    }

    #endregion
}
